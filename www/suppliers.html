<!DOCTYPE html> 
<html> 
<head>
  <meta charset="utf-8" /> 
  <title>Health in Hand</title>
  
  <link href="css/jquery.mobile-1.0a4.1.min.css" rel="stylesheet" />
  <link href="css/theme.css" rel="stylesheet" />
  <link href="css/main.css" rel="stylesheet" />
  
  <!-- Phonegap and JQM init -->
  <script type="text/javascript" charset="utf-8" src="js/phonegap-0.9.4.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery-1.5.2.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0a4.1.min.js"></script>
  
  <!-- Utilities -->
  <script type="text/javascript" charset="utf-8" src="js/utils.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/names.js"></script>
  
  <!-- API communication -->
  <script type="text/javascript" charset="utf-8" src="js/api.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/keys.js"></script>
  
</head> 
<body>

<div data-role="page" class="page" id="suppliers">

  <!-- Page-specific code -->
  <script type="text/javascript">
    var currentQuery = "";
    
    Utils.show("suppliers", function() {
      $("ul.list.supplies li a").live("click", function() {
        var term = $(this).data("value");
        var search_type = $('input:radio[name=search_type]:checked').val();
        
        if (search_type == "nearby")
          searchNearby(term);
        else
          searchZip(term);
        
        return false;
      });
      
      $("input.supplies.radio").change(function() {
        var search_type = $('input:radio[name=search_type]:checked').val();
        if (search_type == "zip")
          $("input.supplies.search.zipcode").attr("disabled", "");
        else
          $("input.supplies.search.zipcode").attr("disabled", "disabled");
      });
      
      $("input.search.supplies.text").change(function() {
        var query = $(this).val().trim();
        if (!query) {
          $("ul.list.supplies").html("");
          return;
        }
        
        if (currentQuery == query)
          return;
        
        currentQuery = query;
        
        Utils.log("filter: " + query);
        
        Api.Supplier.terms(query, function(supplies) {
          if (supplies) {
            Utils.log("got back " + supplies.length + " results");
            populateSupplies(supplies);
          }
        });
      }).keyup(function() { $(this).change(); });
      
    });
    
    function populateSupplies(supplies) {
      Utils.loadList("supplies", supplies, function(supply) {
        
        // link won't be used, live click handler will be used instead
        return "" + 
          "<a href=\"#\" data-value=\"" + supply.term.replace(/\"/g, "\\\"") + "\">" +
            supply.term + 
          "</a>";
      }, {empty: "No supplies found.",});
    }
    
    function searchNearby(supply) {
      Utils.loading();
        
      Utils.location(function (lat, lng) {
        Utils.loading(true);
        $.mobile.changePage({
          url: "suppliers_list.html",
          data: {lat: lat, lng: lng, supply: supply},
          type: "get"
        });
      });
    }
    
    function searchZip(supply) {
      var zip = $("input.supplies.zipcode").val().trim();
      if (!zip)
        Utils.popup("Searching by zip code", "If you want to limit results to a zip code, enter one before selecting a supplier.");
      else {
        $.mobile.changePage({
          url: "suppliers_list.html",
          data: {zip: zip, supply: supply},
          type: "get"
        });
      }
    }
    
  </script>

  <div data-role="content">
    <div class="content-banner">
		<a href="#" class="info">About</a>
      <h1>Sunlight Health</h1>
      <p>
        Drill down a little deeper. Find out more about the facilities near you.
      </p>
    </div>
	<div class="scallop">
		
	</div>

  <div data-role="fieldcontain">
    <fieldset data-role="controlgroup" data-type="horizontal">
      <input type="radio" name="search_type" value="nearby" class="radio supplies nearby" id="search_type-nearby" checked="checked" />
      <label for="search_type-nearby">Nearby</label>
      <input type="radio" name="search_type" value="zip" class="radio supplies zip" id="search_type-zip" />
      <label for="search_type-zip">Zipcode</label>
    </fieldset>
  </div>

	<script type="text/javascript" charset="utf-8" src="js/jquery-placehold-0.3.min.js"></script>
	
	<input class="search supplies zipcode" type="text" name="zip" placeholder="Enter a zipcode..." disabled="disabled" />
	<input class="search supplies text" type="text" name="query" placeholder="Start typing what you're looking for..." />

	<ul data-role="listview" data-theme="e" class="list supplies">
	  <!-- supply list goes here, template specified in JavaScript above -->
	</ul>
	
  </div><!-- /content -->

	<div data-role="footer" data-position="fixed" data-id="stickey_footer" id="stickey_footer">
		<div data-role="navbar">
			<ul>
				<li><a href="facilities.html" data-icon="nav-icons" id="facilities_nav">Facilities</a></li>
				<li><a href="suppliers.html" data-icon="nav-icons" id="suppliers_nav" class="ui-btn-active ui-state-persist">Suppliers</a></li>
				<li><a href="drugs.html" data-icon="nav-icons" id="drugs_nav">Drugs</a></li>
			</ul>
		</div><!-- /navbar -->

  </div><!-- /footer -->

</div><!-- /page -->

</body>
</html>