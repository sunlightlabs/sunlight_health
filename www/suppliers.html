<!DOCTYPE html> 
<html> 
<head>
  <meta charset="utf-8" /> 
  <title>Sunlight Health</title>
  
  <link href="css/jquery.mobile-1.0a4.1.min.css" rel="stylesheet" />
  <link href="css/theme.css" rel="stylesheet" />
  <link href="css/main.css" rel="stylesheet" />
  
  <!-- Phonegap and JQM init -->
  <script type="text/javascript" charset="utf-8" src="js/phonegap-0.9.4.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery-1.5.2.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0a4.1.min.js"></script>
  
  <!-- Utilities -->
  <script type="text/javascript" charset="utf-8" src="js/utils.js"></script>
  
  <!-- API communication -->
  <script type="text/javascript" charset="utf-8" src="js/api.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/keys.js"></script>
  
</head> 
<body>

<div data-role="page" class="page" id="suppliers">

  <script type="text/javascript">
    var currentQuery = "";
    
    Utils.show("suppliers", function() {
      $("ul.list.supplies li a").live("click", function() {
        var term = $(this).data("value");
        var search_type = $('input:radio[name=search_type]:checked').val();
        var radius = $('input:radio[name=radius]:checked').val();
        
        if (search_type == "nearby")
          searchNearby(term, radius);
        else
          searchZip(term, radius);
        
        return false;
      });
      
      $("input.supplies.radio").change(function() {
        var search_type = $('input:radio[name=search_type]:checked').val();
        if (search_type == "zip")
          $("input.supplies.search.zipcode").show();
        else
          $("input.supplies.search.zipcode").hide();
      });
      
      $("input.search.supplies.text").change(function() {
        var query = $(this).val().trim();
        
        if (currentQuery == query)
          return;
        currentQuery = query;
        
        if (!query) {
          $("ul.list.supplies").html("");
          return;
        }
        
        Utils.log("filter: " + query);
        
        $("input.search.text.supplies").addClass("loading");
        Api.Supplier.terms(query, function(supplies) {
          $("input.search.text.supplies").removeClass("loading");
          
          if (supplies) {
            Utils.log("got back " + supplies.length + " results");
            populateSupplies(supplies);
          }
        });
      }).keyup(function() { $(this).change(); });
      
    });
    
    function populateSupplies(supplies) {
      Utils.loadList("supplies", supplies, function(supply) {
        
        // link won't be used, live click handler will be used instead
        return "" + 
          "<a href=\"#\" data-value=\"" + supply.term.replace(/\"/g, "\\\"") + "\">" +
            supply.term + 
          "</a>";
      }, {empty: "No supplies found.",});
    }
    
    function searchNearby(supply, radius) {
      $(".suppliers.thinking.main").show();
        
      Utils.location(function (lat, lng) {
        $(".suppliers.thinking.main").hide();
        $.mobile.changePage({
          url: "suppliers_list.html",
          data: Utils.cleanedData({lat: lat, lng: lng, radius: radius, supply: supply, search_type: "nearby"}),
          type: "get"
        });
      });
    }
    
    function searchZip(supply, radius) {
      var zip = $("input.supplies.zipcode").val().trim();
      if (!zip)
        Utils.popup("If you want to limit results to a zip code, enter one before selecting a supplier.");
      else if (zip.match(/[^\d]/))
        Utils.popup("Enter a valid zip code.");
      else {
        $.mobile.changePage({
          url: "suppliers_list.html",
          data: Utils.cleanedData({zip: zip, supply: supply, radius: radius, search_type: "zip"}),
          type: "get"
        });
      }
    }
    
  </script>

  <div data-role="content">
    <div class="content-banner">
      <a href="about.html" data-transition="fade" class="info">About</a>
      <div class="thinking suppliers main hidden"></div>
      
      <h1>Sunlight Health</h1>
      <p>
        Looking for medical supplies? See who carries it.
      </p>
    </div>
    
    <div class="scallop"></div>

    <div data-role="fieldcontain">
      <fieldset data-role="controlgroup" data-type="horizontal">
        <input type="radio" name="search_type" value="nearby" class="radio supplies nearby" id="search_type-nearby" checked="checked" />
        <label for="search_type-nearby">Nearby</label>
        <input type="radio" name="search_type" value="zip" class="radio supplies zip" id="search_type-zip" />
        <label for="search_type-zip">Zipcode</label>
      </fieldset>
    </div>
    
    <div data-role="fieldcontain">
      <fieldset data-role="controlgroup" data-type="horizontal">
        <input type="radio" name="radius" value="small" class="radio radius small" id="radius-small" />
        <label for="radius-small">5 miles</label>
        <input type="radio" name="radius" value="medium" class="radio radius medium" id="radius-medium" checked="checked" />
        <label for="radius-medium">25 miles</label>
        <input type="radio" name="radius" value="large" class="radio radius large" id="radius-large" />
        <label for="radius-large">100 miles</label>
      </fieldset>
    </div>

    <script type="text/javascript" charset="utf-8" src="js/jquery-placehold-0.3.min.js"></script>
	
    <div class="ui-select">
      <input class="search supplies zipcode" type="number" name="zip" placeholder="Enter a zipcode..." style="display: none" />
      <input class="search supplies text" type="text" name="query" placeholder="Start typing what you're looking for..." />

    </div>

    <ul data-role="listview" data-theme="e" class="list supplies">
      <!-- supply list goes here, template specified in JavaScript above -->
    </ul>
	
  </div><!-- /content -->

	<div data-role="footer" data-position="fixed" data-id="stickey_footer" id="stickey_footer">
		<div data-role="navbar">
			<ul>
				<li><a href="index.html" data-icon="nav-icons" id="facilities_nav">Facilities</a></li>
				<li><a href="suppliers.html" data-icon="nav-icons" id="suppliers_nav" class="ui-btn-active ui-state-persist">Suppliers</a></li>
				<li><a href="drugs.html" data-icon="nav-icons" id="drugs_nav">Drugs</a></li>
			</ul>
		</div><!-- /navbar -->

  </div><!-- /footer -->

</div><!-- /page -->

</body>
</html>