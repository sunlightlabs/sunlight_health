<!DOCTYPE html> 
<html> 
<head>
  <meta charset="utf-8" /> 
  <title>Health in Hand</title>
  
  <link href="css/jquery.mobile-1.0a4.1.min.css" rel="stylesheet" />
  <link href="css/theme.css" rel="stylesheet" />
  <link href="css/main.css" rel="stylesheet" />
  
  <!-- Phonegap and JQM init -->
  <script type="text/javascript" charset="utf-8" src="js/phonegap-0.9.4.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery-1.5.2.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0a4.1.min.js"></script>
  
  <!-- Utilities -->
  <script type="text/javascript" charset="utf-8" src="js/utils.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/names.js"></script>
  
  <!-- API communication -->
  <script type="text/javascript" charset="utf-8" src="js/api.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/keys.js"></script>
</head>

<div data-role="page" class="page" id="drug_chemical">

  <!-- Page-specific code -->
  <script type="text/javascript">
    var supplier;
    
    Utils.show("drug_chemical", function() {
      
      var name = Utils.param("name");
      var drug_name = Utils.param("drug_name");
      var drug_class = Utils.param("drug_class");
      var subdivision = Utils.param("subdivision");
      
      Utils.loading();
      Api.Drug.chemical(name, drug_class, subdivision, ["basic", "drugs"], function(chemical) {
        Utils.loading(true);
        
        if (!chemical)
          return; // TODO: dialog
        
        populateChemical(chemical);
        populateDrugs(chemical.drugs);
        
        Api.Drug.chemical(name, drug_class, subdivision, ["class_description"], function(chemical) {
          if (!chemical)
            return;
          
          populateDescription(chemical.class_description);
          
          Api.Drug.classExcept(drug_class, name, function(chemicals) {
            populateChemicals(chemicals);
          });
          
        });
        
      });
      
    });
    
    function populateChemical(chemical) {
      $(".chemical.name").html(chemical.name);
      $(".chemical.class").html(
        chemical.drug_class + ", " + chemical.subdivision
      );
      $(".chemical.drug_names").html(chemical.drug_names.join(", "));
      
      $(".chemical.content-banner").show();
    }
    
    function populateDrugs(drugs) {
      
      for (var i=0; i<drugs.length; i++) {
        var drug = drugs[i];
        
        var html = "" +
          "<div class=\"chemical drug\">" +
            "<h2 class=\"drug name\">" + drug.name + "</h2>" +
            "<table class=\"data\">" +
              "<tbody>";
        
        for (var j=0; j<drug.doses.length; j++) {
          var dose = drug.doses[j];
          html += "" +
                "<tr class=\"" + (j % 2 == 0 ? "even" : "odd") + "\">" +
                  "<th scope=\"row\" class=\"drug dosage\">" +
                    "<h3 class=\"drug dosage name" + (dose.best_buy ? " best-buy" : "") +"\">" +
                      dose.dosage +
                      (dose.best_buy ? "<span class=\"consumer-reports\">A Consumer Reports Best Buy Drug</span>" : "") +
                    "</h3>" +
                    "<div class=\"drug notes\">";
          
          for (var k=0; k<dose.notes.length; k++) {
            var note = dose.notes[k];
            html += "" +
                      "<dt>" +
                        note.name + 
                      ":</dt>" +
                      "<dd>" +
                        note.value +
                      "</dd>";
          }
                    
          html += "" +
                    "</div>" +
                  "</th>" +
                  "<td class=\"drug cost\">" +
                    dose.cost +
                  "</td>" +
                "</tr>";
        }
        
        html += "" +
              "</tbody>" +
            "</table>";
            
        $(".chemical.drugs").append(html);
      }
      
      $(".cost-comparison").show();
    }
    
    function populateDescription(description) {
      if (description.length > 400)
        description = description.substring(0,400) + "...";
      $("p.drug_class.description").html(description);
    }
    
    function populateChemicals(chemicals) {
      Utils.loadList("chemicals", chemicals, function(chemical) {
        return Utils.chemicalItem(chemical);
      }, {
        empty: "No other drugs found in this drug class.",
        divider: "subdivision"
      });
    }
    
  </script>

  <div data-role="header">
    <h1>
      Drug Details
    </h1>
  </div><!-- /header -->

  <div data-role="content"> 
    
    <div class="chemical content-banner hidden">
      <div class="top">
		<h3 class="chemical name">
	      <!-- chemical name -->
	    </h3>
		<dl>
        <dt>Class</dt>
        <dd class="chemical class">
          <!-- chemical class and subdivision names -->
        </dd>
        <dt class="clear">Chemical</dt>
        <dd class="chemical name">
          <!-- chemical name -->
        </dd>
        <dt class="clear">Includes</dt>
        <dd class="chemical drug_names">
          <!-- drug names associated with this chemical -->
        </dd>
		</dl>
      </div>
    </div>
    
    <div class="scallop"></div>
    
    <div data-role="collapsible" data-collapsed="true" class="cost-comparison hidden">
      <h1>Cost Comparison</h1>
      
      <div class="chemical drugs">
      
        <!-- example drug, this whole block will get repeated for each drug
        <div class="chemical drug">
          <h2 class="drug name">Generic</h2>
          <table class="data">
            <tbody>
            
              <!-- a tr row for each dosage --><!--
              <tr class="odd"> 
                <th scope="row" class="drug dosage">
                  <h3 class="drug dosage name best-buy">
                    75 mg tablet
                  </h3>
                  <div class="drug notes">
                    <!-- a dt/dd pair for each note --><!--
                    
                    <dt>Frequency of use per day</dt>
                    <dd>Two</dd>
                    <dt>Total daily dose</dt>
                    <dd>150mg</dd>
                    <dt>Best buy indication</dt>
                    <dd>High blood pressure, for people with kidney disease</dd>
                  </div>
                </th>
                <td class="drug cost">
                  $132
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        -->
      </div>
      <p class="more"><a href="">read more about these data sets...</a></p>
    </div>
    
    <div data-role="collapsible" data-collapsed="true" class="drug_class about">
      <h1>About this Drug Class</h1>
      <p class="drug_class description">
        <!-- example text
          Antidepressants can improve the symptoms of depression, but they can also have serious side effects. So you don't want to take one if you don't have to. The information in this report can help you decide--with your doctor or mental-health professional--whether an antidepressant might be right for you, and if so, which one...
        -->
      </p>
    </div>
    
    <div data-role="collapsible" data-collapsed="true" class="other chemicals" data-theme="c">
      <h1>Other Chemicals in this Class</h1>
      
      <ul data-role="listview" data-theme="c" class="list chemicals">
        <!-- gets filled in identically to the list of chemicals in drug_class.html -->
      </ul>
    </div>
      
</div><!-- /content -->
	<div data-role="footer" data-position="fixed" data-id="stickey_footer" id="stickey_footer">
		<div data-role="navbar">
			<ul>
				<li><a href="facilities.html" data-icon="nav-icons" id="facilities_nav">Facilities</a></li>
				<li><a href="suppliers.html" data-icon="nav-icons" id="suppliers_nav" >Suppliers</a></li>
				<li><a href="drugs.html" data-icon="nav-icons" id="drugs_nav" class="ui-btn-active ui-state-persist">Drugs</a></li>
			</ul>
		</div><!-- /navbar -->

</div><!-- /footer -->
</div><!-- /page -->

</body>
</html>