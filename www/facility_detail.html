<!DOCTYPE html> 
<html> 
<head>
  <meta charset="utf-8" /> 
  <title>Health in Hand</title>
  
  <link href="css/jquery.mobile-1.0a4.1.min.css" rel="stylesheet" />
  <link href="css/theme.css" rel="stylesheet" />
  <link href="css/main.css" rel="stylesheet" />
  
  <!-- Phonegap and JQM init -->
  <script type="text/javascript" charset="utf-8" src="js/phonegap-0.9.4.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery-1.5.2.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0a4.1.min.js"></script>
  
  <!-- Utilities -->
  <script type="text/javascript" charset="utf-8" src="js/utils.js"></script>
  
  <!-- API communication -->
  <script type="text/javascript" charset="utf-8" src="js/api.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/keys.js"></script>
</head>

<div data-role="page" class="page" id="facility_detail">

  <!-- Page-specific code -->
  <script type="text/javascript">
    
    Utils.show("facility_detail", function() {
      
      var provider_number = Utils.param("provider_number");
      var facility_type = Utils.param("facility_type");
      
      var sections;
      if (facility_type == "nursing_home")
        sections = ["basic", "ratings"]; // ratings section is small enough to just fetch it now
      else
        sections = ["basic"];
      
      Utils.loading();
      Api.Facility.find(provider_number, facility_type, sections, function(facility) {
        Utils.loading(true);
        if (!facility) return;
        
        populateFacility(facility);
        
        if (facility.facility_type == "nursing_home")
          populateNursingHome(facility.ratings);
          
//         Utils.bgLoading();
//         Api.Supplier.find(row, ["supplies"], function(supplier) {
//           Utils.bgLoading(true);
//           if (!supplier) return;
//           
//           populateList(supplier.supplies);
//         });
        
      });
      
    });
    
    function populateFacility(facility) {
      $(".facility .name").html(facility.name);
      $(".facility .address").html(Utils.address(facility, {break: true}));
      $(".facility .phone").html(Utils.phone(facility.phone));
      $(".facility a.call").attr("href", "tel://" + facility.phone);
      $(".facility a.directions").attr("href", Utils.directions(Utils.address(facility)));
      
      $(".facility.map").click(function() {
        $.mobile.changePage({
          url: "facility_map.html",
          data: {
            provider_number: facility.provider_number,
            address: facility.address,
            address_2: facility.address_2,
            zip: facility.zip,
            zip_plus_4: facility.zip_plus_4,
            city: facility.city,  
            state: facility.state,
            name: facility.name,
            phone: facility.phone.replace(/[\(\)]/g, '')
          },
          type: "get"
        });
      });
      
      $(".facility.reveal").show();
    }
    
    function populateNursingHome(ratings) {
      var html = "";
      html += "" +
        "<tr class=\"odd\">" +
          "<th scope=\"row\">Overall</td>" +
          "<td class=\"rating-" + ratings.overall + "\"></td>" +
        "</tr>" +
        "<tr class=\"even\">" +
          "<th scope=\"row\">Health Inspections</td>" +
          "<td class=\"rating-" + ratings.health_inspections + "\"></td>" +
        "</tr>" +
        "<tr class=\"odd\">" +
          "<th scope=\"row\">Nurse Staffing</td>" +
          "<td class=\"rating-" + ratings.nurse_staffing + "\"></td>" +
        "</tr>" +
        "<tr class=\"even\">" +
          "<th scope=\"row\">RN Only</td>" +
          "<td class=\"rating-" + ratings.rn_only + "\"></td>" +
        "</tr>";
    
      $(".facility.loading").hide();
      $(".facility.nursing_home_ratings table.data tbody").html(html);
      
      $(".facility.hidden").show();
    }
    
  </script>

  <div data-role="header">
    <h1>Facility Details</h1>
    <a data-role="button" class="ui-btn-right map facility reveal">Map</a>
  </div><!-- /header -->

  <div data-role="content"> 
    <div class="facility reveal">
      <div class="content-banner">
        <div class="top">
          <h3 class="name"></h3>
          <p class="address"></p>
          <p class="phone"></p>
        </div>
      </div>
      
      <div class="scallop"></div>
      
      <div class="buttons ui-grid-a">
        <div class="ui-block-a">
          <a href="#" data-role="button" class="call">Call</a>
        </div>
        <div class="ui-block-b">
          <a href="#" data-role="button" class="directions">Directions</a>
        </div>
      </div>
      
      <p class="facility loading">
        Loading data about this facility...
      </p>
      
      <div class="facility hidden">
      
        <div data-role="collapsible" class="facility nursing_home_ratings">
          <h1>Ratings</h1>
          
          <table class="data">
            <thead>
              <tr>
                <th scope="col"></th>
                <th class="hosp" scope="col">Rating</th>
              </tr>
            <tbody>
              <!-- example
                <tr class="odd">
                  <th scope="row">Overall</th>
                  <td class="ratings-5"></td>
                </tr>
              -->
            </tbody>
          </table>
        </div>
        
      </div><!-- end container of additional sections -->
      
    </div>
  </div><!-- /content -->
  
  <div data-role="footer" id="stickey_footer">
    <div data-role="navbar">
      <ul>
        <li><a href="facilities.html" class="ui-btn-active">Facilities</a></li>
        <li><a href="suppliers.html">Suppliers</a></li>
        <li><a href="drugs.html">Drugs</a></li>
      </ul>
    </div><!-- /navbar -->
  </div><!-- /footer -->
  
</div><!-- /page -->

</body>
</html>