<!DOCTYPE html> 
<html> 
<head>
  <meta charset="utf-8" /> 
  <title>Health in Hand</title>
  
  <link href="css/jquery.mobile-1.0a4.1.min.css" rel="stylesheet" />
  <link href="css/theme.css" rel="stylesheet" />
  <link href="css/main.css" rel="stylesheet" />
  
  <!-- Phonegap and JQM init -->
  <script type="text/javascript" charset="utf-8" src="js/phonegap-0.9.4.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery-1.5.2.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/jquery.mobile-1.0a4.1.min.js"></script>
  
  <!-- Utilities -->
  <script type="text/javascript" charset="utf-8" src="js/utils.js"></script>
  
  <!-- API communication -->
  <script type="text/javascript" charset="utf-8" src="js/api.js"></script>
  <script type="text/javascript" charset="utf-8" src="js/keys.js"></script>
</head>

<div data-role="page" class="page" id="facility_detail">

  <!-- Page-specific code -->
  <script type="text/javascript">
    
    Utils.show("facility_detail", function() {
      
      var provider_number = Utils.param("provider_number");
      var facility_type = Utils.param("facility_type");
      
      
      Utils.loading();
      Api.Facility.find(provider_number, facility_type, ["basic"], function(facility) {
        Utils.loading(true);
        if (!facility) return;
        
        populateFacility(facility);
        
        if (facility_type == "nursing_home") {
          Utils.bgLoading();
          Api.Facility.find(provider_number, facility_type, ["ratings", "extended"], function(facility) {
            Utils.bgLoading(true);
            if (!facility) return;
            window.facility = facility;
            populateNursingHome(facility.ratings, facility.extended);
          });
        }
        
        else if (facility_type == "home_health") {
          Utils.bgLoading();
          Api.Facility.find(provider_number, facility_type, ["extended.services", "extended.patient_improvement"], function(facility) {
            Utils.bgLoading(true);
            if (!facility) return;
            
            populateHomeHealth(facility.extended.services, facility.extended.patient_improvement);
          });
        }
        
        else if (facility_type == "dialysis") {
          Utils.bgLoading();
          Api.Facility.find(provider_number, facility_type, ["extended", "services"], function(facility) {
            Utils.bgLoading(true);
            if (!facility) return;
            
            populateDialysis(facility.extended, facility.services);
          });
        }
        
        else if (facility_type == "hospital") {
          Utils.bgLoading();
          Api.Facility.find(provider_number, facility_type, ["survey_experiences", "outcomes"], function(facility) {
            Utils.bgLoading(true);
            if (!facility) return;
            
            populateHospital(facility.survey_experiences, facility.outcomes);
          });
        }
        
      });
      
    });
    
    function populateFacility(facility) {
      $(".facility .name").html(facility.name);
      $(".facility .address").html(Utils.address(facility, {line_break: true}));
      $(".facility .phone").html(Utils.phone(facility.phone));
      $(".facility a.call").attr("href", "tel://" + facility.phone);
      $(".facility a.directions").attr("href", Utils.directions(Utils.address(facility)));
      
      $(".facility.map").click(function() {
        $.mobile.changePage({
          url: "facility_map.html",
          data: {
            provider_number: facility.provider_number,
            address: facility.address,
            address_2: facility.address_2,
            zip: facility.zip,
            zip_plus_4: facility.zip_plus_4,
            city: facility.city,  
            state: facility.state,
            name: facility.name,
            phone: facility.phone.replace(/[\(\)]/g, '')
          },
          type: "get"
        });
      });
      
      if (facility.facility_type == "hospital")
        $(".outliers.hidden").show();
      
      $(".facility.reveal").show();
    }
    
    function populateHospital(survey_experiences, outcomes) {
      var html;
      var i;
      
      html = "";
      i = 0;
      $.each(survey_experiences, function(field, qualifiers) {
        // combine usually and always
        if (qualifiers.usually && qualifiers.always) {
          var name = qualifiers.usually.name;
          var individual = qualifiers.usually.value + qualifiers.always.value;
          var nearby = qualifiers.usually.nearby_average + qualifiers.always.nearby_average;
          var us = qualifiers.usually.national_average + qualifiers.always.national_average;
          
          html += averageRow(i, name, individual, nearby, us);
          
          i += 1;
        } else {
          $.each(qualifiers, function(qualifier, info) {
            var name = info.name;
            var individual = info.value;
            var nearby = info.nearby_average;
            var us = info.national_average;
            
            html += averageRow(i, name, individual, nearby, us);
            i += 1;
          });
        }
      });
      
      $(".facility.hospital .survey_experiences table.data tbody").html(html);
      
      i = 0;
      html = "";
      $.each(outcomes, function(condition, years) {
        $.each(years, function(year, info) {
          if (info.code) {
            html += simpleValueRow(i, info.name, info.code);
            i += 1;
          }
        });
      });
      
      $(".facility.hospital .outcomes table.data tbody").html(html);
      
      
      $(".facility.loading").hide();
      $(".facility.hospital.hidden").show();
    }
    
    function populateNursingHome(ratings, extended) {
      var i, html;
      
      $(".nursing_home.ownership_type").html(extended.ownership_type.value).show();
      $(".nursing_home.overall_rating").addClass("rating-" + ratings.overall.value).show();
      
      html = "" +
        ratingRow(0, ratings.overall.name, ratings.overall.value) +
        ratingRow(1, ratings.rn_only.name, ratings.rn_only.value) +
        ratingRow(2, ratings.nurse_staffing.name, ratings.nurse_staffing.value) +
        ratingRow(3, ratings.health_inspections.name, ratings.health_inspections.value);
    
      $(".facility.nursing_home .ratings table.data tbody").html(html);
      
      
      var percent = parseInt((extended.total_residents.value / extended.certified_bed.value) * 100);
      $(".facility.nursing_home .occupancy div.data span.percent").html(percent + "%");
      $(".facility.nursing_home .occupancy div.data .beds dd").html(extended.certified_bed.value);
      $(".facility.nursing_home .occupancy div.data .residents dd").html(extended.total_residents.value);
      
      
      html = "" +
        booleanRow(0, "Medicaid Participation", extended.program_participation.value.match(/Medicaid/)) +
        booleanRow(1, "Medicare Participation", extended.program_participation.value.match(/Medicare/)) +
        booleanRow(2, extended.within_hospital.name, extended.within_hospital.value) +
        booleanRow(3, extended.multi_ownership.name, extended.multi_ownership.value) +
        simpleValueRow(4, extended.resident_and_family_councils.name, extended.resident_and_family_councils.value) +
        booleanRow(5, extended.continuing_care_retirement_community.name, extended.continuing_care_retirement_community.value) +
        booleanRow(6, extended.special_focus_facility.name, extended.special_focus_facility.value) +
        "";
        
      $(".facility.nursing_home .participation table.data tbody").html(html);
      
      
      $(".facility.nursing_home .inspections div.data .health_survey dd").html(dateFor(extended.health_survey_date.value));
      $(".facility.nursing_home .inspections div.data .fire_survey dd").html(dateFor(extended.fire_survey_date.value));
      
      var val = extended.sprinkler_status.value;
      var klass;
      if (val.match(/Partially/i))
        klass = "partially";
      else if (val.match(/Fully/i))
        klass = "fully";
      else
        klass = "not";
        
      $(".facility.nursing_home .inspections div.data .sprinklers dt").addClass(klass);
      
      
      $(".facility.loading").hide();
      $(".facility.nursing_home.hidden").show();
    }
    
    function populateHomeHealth(services, patient_improvement) {
      var html;
      var i;
      
      html = "";
      i = 0;
      $.each(services, function(key, info) {
        html += booleanRow(i, info.name, info.value);
        i += 1;
      });
      
      $(".facility.home_health .services table.data tbody").html(html);
      
      
      html = "";
      i = 0;
      $.each(patient_improvement, function(key, info) {
        if (info.value != null) {
          html += simpleValueRow(i, info.name, info.value);
          i += 1;
        }
      });
      
      $(".facility.home_health .patient_improvement table.data tbody").html(html);
      
      $(".facility.loading").hide();
      $(".facility.home_health.hidden").show();
    }
    
    function populateDialysis(extended, services) {
      var html, i;
      
      html = "" +
        booleanRow(0, services.in_center_hemodialysis.name, services.in_center_hemodialysis.value) +
        booleanRow(1, services.in_center_peritoneal_dialysis.name, services.in_center_peritoneal_dialysis.value) +
        booleanRow(2, services.home_hemodialysis_training.name, services.in_center_peritoneal_dialysis.value);
      
      $(".facility.dialysis .services table.data tbody").html(html);
      
      
      html = "" +
        simpleValueRow(0, extended.dialysis_stations.name, extended.dialysis_stations.value) +
        simpleValueRow(1, extended.profit_type.name, extended.profit_type.value) +
        simpleValueRow(2, extended.high_hemoglobin.name, percentFor(extended.high_hemoglobin.value)) +
        simpleValueRow(3, extended.low_hemoglobin.name, percentFor(extended.low_hemoglobin.value)) +
        simpleValueRow(4, extended.patient_survival.name, extended.patient_survival.value) +
        simpleValueRow(5, extended.dialysis_adequacy.name, percentFor(extended.dialysis_adequacy.value)) +
        booleanRow(6, extended.late_shift.name, extended.late_shift.value) +
        booleanRow(7, extended.chain_owned.name, extended.chain_owned.value) +
        simpleValueRow(8, extended.chain_organization.name, extended.chain_organization.value) +
        simpleValueRow(9, extended.hgb_number.name, extended.hgb_number.value) +
        "";
      
      $(".facility.dialysis .extended table.data tbody").html(html);
      
      
      $(".facility.loading").hide();
      $(".facility.dialysis.hidden").show();
    }
    
    function booleanRow(i, name, value) {
      return "" +
        "<tr class=\"" + (i % 2 == 0 ? "even" : "odd") + "\">" +
          "<th scope=\"row\">" + name + "</th>" +
          "<td>" + (value ? "Yes" : "No") + "</td>" +
        "</tr>";
    }
    
    function averageRow(i, name, individual, nearby, national) {
      return "" +
        "<tr class=\"" + (i % 2 == 0 ? "even" : "odd") + "\">" +
          "<th scope=\"row\">" + name + "</th>" +
          "<td>" + national + "</td>" +
          "<td>" + nearby + "</td>" +
          "<td>" + individual + "</td>" +
        "</tr>";
    }
    
    function simpleValueRow(i, name, value) {
      return "" +
        "<tr class=\"" + (i % 2 == 0 ? "even" : "odd") + "\">" +
          "<th scope=\"row\">" + name + "</th>" +
          "<td>" + value + "</td>" +
        "</tr>";
    }
    
    function ratingRow(i, name, value) {
      return "" +
        "<tr class=\"" + (i % 2 == 0 ? "even" : "odd") + "\">" +
          "<th scope=\"row\">" + name + "</td>" +
          "<td class=\"rating-" + value + "\"></td>" +
        "</tr>";
    }
    
    function dateFor(string) {
      return string;
    }
    
    function percentFor(string) {
      return string + "%";
    }
    
  </script>

  <div data-role="header">
    <h1>Facility Details</h1>
    <a data-role="button" class="ui-btn-right map facility reveal">Map</a>
  </div><!-- /header -->

  <div data-role="content"> 
    <div class="facility reveal">
      <div class="content-banner">
        <div class="top">
          <h3 class="name"></h3>
          <p class="address"></p>
          <p class="phone"></p>
        </div>
        
        <!-- Currently using mocked up data so that it can be styled. -->
        <div class="outliers hidden">
          <div class="totals">
            <span class="above"><span class="outlier above">7</span>
            above avg measures</span>
            <span class="below"><span class="outlier below">3</span>
            below avg measures</span>
          </div>
          <p class="small">
            Outliers were significantly above/below the national average.
          </p>
        </div>
        
        <div class="nursing_home ownership_type hidden"></div>
        <div class="nursing_home overall_rating hidden"></div>
      </div>
      
      <div class="scallop"></div>
      
      <div class="buttons ui-grid-a">
        <div class="ui-block-a">
          <a href="#" data-role="button" class="call">Call</a>
        </div>
        <div class="ui-block-b">
          <a href="#" data-role="button" class="directions">Directions</a>
        </div>
      </div>
      
      <p class="loading empty facilities">
        <span class='ui-icon ui-icon-loading spin'></span>Loading facilities...
      </p>
      
      <div class="facility hospital hidden">
        
        <div data-role="collapsible" data-collapsed="true" class="survey_experiences">
          <h1>Patient Surveys</h1>
          
          <table class="data">
            <thead>
              <tr>
                <th scope="col"></th>
                <th class="hosp" scope="col">US</th>
                <th class="hosp" scope="col">Local</th>
                <th class="hosp" scope="col">Hosp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <p class="more"><a href="">read more about this data...</a></p>
        </div>
        
        <div data-role="collapsible" data-collapsed="true" class="outcomes">
          <h1>Patient Outcomes</h1>
          
          <table class="data">
            <thead>
              <tr>
                <th scope="col"></th>
                <th class="hosp" scope="col">Compared to US Average</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <p class="more"><a href="">read more about this data...</a></p>
        </div>
        
        <div data-role="collapsible" data-collapsed="false" class="process surgical_care">
          <h1>
            Surgical Care
            <span class="outlier above">3</span>
            <span class="outlier below">1</span>
          </h1>
          <div class="outliers">
            <table class="data summary">
              <thead>
                <tr>
                  <th scope="col"></th>
                  <th class="hosp" scope="col">Local</th>
                  <th class="hosp" scope="col">Hosp</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th scope="row">Number of patients</th>
                  <td class="hosp">79</td>
                  <td class="hosp">79</td>
                </tr>
                <tr>
                  <th scope="row">Average performance</th>
                  <td class="hosp">79%</td>
                  <td class="hosp">79%</td>
                </tr>
              </tbody>
            </table>
              
            <p class="small">
              Outliers were significantly above/below the national average.
            </p>
          </div>
          
          <table class="data values">
            <thead>
              <tr>
                <th scope="col"></th>
                <th class="hosp" scope="col">Fed</th>
                <th class="hosp" scope="col">Local</th>
                <th class="hosp" scope="col">Hosp</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row" class="outlier above">Given an antibiotic at the right time</th>
                <td class="hosp">95%</td>
                <td class="hosp">95%</td>
                <td class="hosp">95%</td>
              </tr>
              <tr>
                <th scope="row" class="outlier above">Antibiotics were stopped at the right time</th>
                <td class="hosp">95%</td>
                <td class="hosp">95%</td>
                <td class="hosp">95%</td>
              </tr>
              <tr>
                <th scope="row" class="outlier below">Given the right kind of antibiotic</th>
                <td class="hosp">95%</td>
                <td class="hosp">95%</td>
                <td class="hosp">95%</td>
              </tr>
              <tr>
                <th scope="row" class="outlier below">Received treatment at right time to help prevent blood clot</th>
                <td class="hosp">85%</td>
                <td class="hosp">84%</td>
                <td class="hosp">72%</td>
              </tr>
              <tr>
                <th scope="row">Received treatment at right time to help prevent blood clot</th>
                <td class="hosp">72%</td>
                <td class="hosp">72%</td>
                <td class="hosp">72%</td>
              </tr>
            </tbody>
          </table>
          <p class="more"><a href="">read more about this data...</a></p>
        </div>
      
      </div><!-- end hospital container -->
      
      <div class="facility nursing_home hidden">
      
        <div data-role="collapsible" data-collapsed="true" class="ratings">
          <h1>Ratings</h1>
          
          <table class="data">
            <thead>
              
            </thead>
            <tbody></tbody>
          </table>
          <p class="more"><a href="">read more about this data...</a></p>
        </div>
        
        <div data-role="collapsible" data-collapsed="true" class="occupancy">
          <h1>Occupancy</h1>
          
          <div class="data">
            <span class="percent">
            </span>
            <div class="beds">
              <dt>Certified Beds</dt>
              <dd></dd>
            </div>
            <div class="residents">
              <dt>Residents</dt>
              <dd></dd>
            </div>
          </div>
          <p class="more"><a href="">read more about this data...</a></p>
        </div>

        <div data-role="collapsible" data-collapsed="true" class="participation">
          <h1>Facility Participation</h1>
          
          <table class="data">
            <thead></thead>
            <tbody></tbody>
          </table>
          <p class="more"><a href="">read more about this data...</a></p>
        </div>
        
        <div data-role="collapsible" data-collapsed="true" class="inspections">
          <h1>Inspections</h1>
          
          <div class="data">
            <div class="health_survey">
              <dt>Health Survey</dt>
              <dd></dd>
            </div>
            <div class="fire_survey">
              <dt>Fire Survey</dt>
              <dd></dd>
            </div>
            <div class="sprinklers">
              <dt>Sprinklers</dt>
              <dd></dd><!-- will get marked with class "checked" or "unchecked" -->
            </div>
          </div>
          <p class="more"><a href="">read more about this data...</a></p>
        </div>
        
      </div><!-- end nursing home container -->
      
      <div class="facility home_health hidden">
        
        <div data-role="collapsible" data-collapsed="true" class="services">
          <h1>Services</h1>
          
          <table class="data">
            <thead>
              <tr>
                <th scope="col"></th>
                <th class="hosp" scope="col">Offered?</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
		  <p class="more"><a href="">read more about this data...</a></p>
		  
        </div>
        
        <div data-role="collapsible" data-collapsed="true" class="patient_improvement">
          <h1>Patient Outcomes</h1>
          
          <table class="data">
            <thead>
              <tr>
                <th scope="col"></th>
                <th class="hosp" scope="col">% Patients</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
		  <p class="more"><a href="">read more about this data...</a></p>
		  
        </div>
      
      </div><!-- end home health container -->
      
      <div class="facility dialysis hidden">
 
        
        <div data-role="collapsible" data-collapsed="true" class="services">
          <h1>Services</h1>
          
          <table class="data">
            <thead>
              <tr>
                <th scope="col"></th>
                <th class="hosp" scope="col">Offered?</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <p class="more"><a href="">read more about this data...</a></p>
		  
        </div>

		<div data-role="collapsible" data-collapsed="true" class="extended">
          <h1>More Info</h1>
          
          <table class="data">
            <thead></thead>
            <tbody></tbody>
          </table>
          <p class="more"><a href="">read more about this data...</a></p>
        </div>
      
      </div><!-- end dialysis container -->
      
    </div>
  </div><!-- /content -->
  
  <div data-role="footer" data-position="fixed" data-id="stickey_footer" id="stickey_footer">
    <div data-role="navbar">
      <ul>
        <li><a href="index.html" data-icon="nav-icons" id="facilities_nav" class="ui-btn-active ui-state-persist">Facilities</a></li>
        <li><a href="suppliers.html" data-icon="nav-icons" id="suppliers_nav" >Suppliers</a></li>
        <li><a href="drugs.html" data-icon="nav-icons" id="drugs_nav">Drugs</a></li>
      </ul>
    </div><!-- /navbar -->
  </div><!-- /footer -->
  
</div><!-- /page -->

</body>
</html>